  name: Testing and deployment of a Django Project

  on:
    push:
      branches:
        - ci
        - master
  jobs:
    testing:
      runs-on: ubuntu-22.04
      env:
        KEY_SECRET: ${{ secrets.DJANGO_SECRET }}
        IS_DEBUG: ${{ secrets.DJANGO_DEBUG }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
        ENGINE: ${{ secrets.DATABASE_ENGINE }}
        USER: ${{ secrets.DATABASE_USER }}
        PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        HOST: ${{ secrets.DATABASE_HOST }}
        NAME: ${{ secrets.DATABASE_NAME }}
        PORT: ${{ secrets.DATABASE_PORT }}
      services:
        postgres_main:
          image: postgres:12
          env:
            POSTGRES_DB: ${{ env.NAME }}
            POSTGRES_USER: ${{ env.USER }}
            POSTGRES_PASSWORD: ${{ env.PASSWORD }}
          ports:
            - 5432:5432
          options:
            --health-cmd pg_isready 
            --health-interval 5s 
            --health-timeout 5s 
            --health-retries 5
      steps:
        - name: Проверка наличия изменений в репозитории
          uses: actions/checkout@v3

        - name: Установка Python и доп библиотек
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'

        - name: Установка зависимостей проекта
          run: pip install -r requirements.txt

        - name: Линтинг (PEP8)
          run: flake8 logistic --exclude logistic/migrations/

        - name: Тестирование
          run: python manage.py test
          env:
            KEY_SECRET: ${{ env.DJANGO_SECRET }}
            IS_DEBUG: ${{ env.DJANGO_DEBUG }}
            ALLOWED_HOSTS: ${{ env.ALLOWED_HOSTS }}
            ENGINE: ${{ env.DATABASE_ENGINE }}
            USER: ${{ env.DATABASE_USER }}
            PASSWORD: ${{ env.DATABASE_PASSWORD }}
            HOST: ${{ env.DATABASE_HOST }}
            NAME: ${{ env.DATABASE_NAME }}
            PORT: ${{ env.DATABASE_PORT }}
  #       run: pytest

  #      - name: Деплой

